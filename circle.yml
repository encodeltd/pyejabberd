machine:
    services:
        - docker
    python:
        version: 2.7.6
    environment:
        PYEJABBERD_TESTS_HOST: 127.0.0.1
        PYEJABBERD_TESTS_PORT: 4560
        PYEJABBERD_TESTS_USERNAME: admin
        PYEJABBERD_TESTS_PASSWORD: admin
        PYEJABBERD_TESTS_XMPP_DOMAIN: example.com
        PYEJABBERD_TESTS_MUC_SERVICE: conference
        PYEJABBERD_TESTS_PROTOCOL: http
        PYEJABBERD_TESTS_VERBOSE: 0
        PIP_CACHE_DIR: ~/pip-cache
    post:
        - pyenv global pypy-2.4.0 2.6.8 2.7.9 3.3.3 3.4.2
dependencies:
    cache_directories:
        - "~/docker"
        - "~/pip-cache"
    pre:
        - pip install -U setuptools pip wheel
    override:
        - pip install tox
        - docker info
        - if [[ -e ~/docker/ejabberd-latest.tar ]]; then docker load --input ~/docker/ejabberd-latest.tar; fi
        - docker pull markuz/pyejabberd-test-server:latest
        - mkdir -p ~/docker; docker save markuz/pyejabberd-test-server:latest > ~/docker/ejabberd-latest.tar
        #- if [[ -e ~/docker/ejabberd-15.09.tar ]]; then docker load --input ~/docker/ejabberd-15.09.tar; fi
        #- docker pull markuz/pyejabberd-test-server:15.09
        #- mkdir -p ~/docker; docker save markuz/pyejabberd-test-server:15.09 > ~/docker/ejabberd-15.09.tar
        #- if [[ -e ~/docker/ejabberd-15.10.tar ]]; then docker load --input ~/docker/ejabberd-15.10.tar; fi
        #- docker pull markuz/pyejabberd-test-server:15.10
        #- mkdir -p ~/docker; docker save markuz/pyejabberd-test-server:15.10 > ~/docker/ejabberd-15.10.tar
        #- if [[ -e ~/docker/ejabberd-15.11.tar ]]; then docker load --input ~/docker/ejabberd-15.11.tar; fi
        #- docker pull markuz/pyejabberd-test-server:15.11
        #- mkdir -p ~/docker; docker save markuz/pyejabberd-test-server:15.11 > ~/docker/ejabberd-15.11.tar
test:
    pre:
        - export EJABBERD_VERSION=latest; export EJABBERD_XMLRPC_PORT=4560; ./ejabberd.sh
        #- export EJABBERD_VERSION=15.09; export EJABBERD_XMLRPC_PORT=4561; ./ejabberd.sh
        #- export EJABBERD_VERSION=15.10; export EJABBERD_XMLRPC_PORT=4562; ./ejabberd.sh
        #- export EJABBERD_VERSION=15.11; export EJABBERD_XMLRPC_PORT=4563; ./ejabberd.sh
    override:
        - sleep 10
        - tox
